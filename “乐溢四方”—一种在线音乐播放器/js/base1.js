const lrc0 = `
[00:00.01]
[00:00.02]
[00:00.03]
[00:00.05]
[00:00.06]
[00:00.07]
[00:03.01]歌曲名 江南(经典风行版)
[00:04.04]歌手名 林俊杰
[00:05.94]作词：李瑞洵
[00:10.04]作曲：林俊杰
[00:15.74]编曲：蔡政勋/陈建玮
[00:20.74]
[00:36.26]风到这里就是黏
[00:39.71]黏住过客的思念
[00:44.00]雨到了这里缠成线
[00:47.69]缠着我们留恋人世间
[00:52.18]你在身边就是缘
[00:55.62]缘分写在三生石上面
[01:00.26]爱有万分之一甜
[01:03.65]宁愿我就葬在这一点
[01:07.94]圈圈圆圆圈圈
[01:09.84]天天年年天天的我
[01:12.33]深深看你的脸
[01:15.03]生气的温柔
[01:16.92]埋怨的温柔的脸
[01:23.41]不懂爱恨情愁煎熬的我们
[01:26.75]都以为相爱就像风云的善变
[01:30.94]相信爱一天抵过永远
[01:35.18]在这一刹那冻结了时间
[01:38.97]不懂怎么表现温柔的我们
[01:42.81]还以为殉情只是古老的传言
[01:46.70]离愁能有多痛痛有多浓
[01:51.29]当梦被埋在江南烟雨中
[01:54.58]心碎了才懂
[02:20.14]圈圈圆圆圈圈
[02:21.78]天天年年天天的我
[02:24.33]深深看你的脸
[02:27.07]生气的温柔
[02:28.97]埋怨的温柔的脸
[02:34.95]不懂爱恨情愁煎熬的我们
[02:38.79]都以为相爱就像风云的善变
[02:42.88]相信爱一天抵过永远
[02:47.37]在这一刹那冻结了时间
[02:50.97]不懂怎么表现温柔的我们
[02:54.81]还以为殉情只是古老的传言
[02:58.80]离愁能有多痛痛有多浓
[03:03.24]当梦被埋在江南烟雨中
[03:06.58]心碎了才懂
[03:19.05]相信爱一天抵过永远
[03:23.24]在这一刹那冻结了时间
[03:26.93]不懂怎么表现温柔的我们
[03:30.78]还以为殉情只是古老的传言
[03:34.72]离愁能有多痛痛有多浓
[03:39.26]当梦被埋在江南烟雨中
[03:44.64]心碎了才懂`;


const lrc1 = `
[00:00.01]
[00:00.02]
[00:00.03]
[00:00.05]
[00:00.06]
[00:00.07]
[00:01.00] 背对背拥抱
[00:02.00] 词：林怡凤
[00:04.00] 曲：林俊杰
[00:06.00] 编曲：吴庆隆
[00:08.00] 制作人：吴剑泓

[00:15.00] 话总说不清楚
[00:17.00] 该怎么明了
[00:22.00] 一字一句像圈套
[00:29.00] 旧账总翻不完
[00:32.00] 谁无理取闹
[00:35.00] 你的双手甩开刚好的微妙
[00:41.00] 然后战火再燃烧
[00:43.00] 
[00:48.00] 我们背对背拥抱
[00:52.00] 滥用沉默在咆哮
[00:56.00] 爱情来不及变老
[01:00.00] 葬送在烽火的玩笑
[01:04.00] 
[01:04.00] 我们背对背拥抱
[01:08.00] 真话兜着圈子乱乱绕
[01:12.00] 只是想让我知道
[01:16.00] 只是想让你知道
[01:20.00] 爱的警告
[01:24.00] 
[01:24.00] 话总说不清楚
[01:28.00] 该怎么明了
[01:32.00] 一字一句像圈套
[01:36.00] 旧账总翻不完
[01:40.00] 谁无理取闹
[01:44.00] 你的双手甩开刚好的微妙
[01:48.00] 然后战火再燃烧
[01:52.00] 
[01:52.00] 我们背对背拥抱
[01:56.00] 滥用沉默在咆哮
[02:00.00] 爱情来不及变老
[02:04.00] 葬送在烽火的玩笑
[02:08.00] 
[02:08.00] 我们背对背拥抱
[02:12.00] 真话兜着圈子乱乱绕
[02:16.00] 只是想让我知道
[02:20.00] 只是想让你知道
[02:24.00] 爱的警告
[02:28.00] 
[02:32.00] 我不要
[02:36.00] 一直到
[02:40.00] 形同陌路变成自找
[02:44.00] 既然可以拥抱
[02:48.00] 就不要轻易放掉
[02:52.00] 
[02:52.00] 我们背对背拥抱
[02:56.00] 滥用沉默在咆哮
[03:00.00] 爱情来不及变老
[03:04.00] 葬送在烽火的玩笑
[03:08.00] 
[03:08.00] 我们背对背拥抱
[03:12.00] 真话兜着圈子乱乱绕
[03:16.00] 只是想让我知道
[03:20.00] 只是想让你知道
[03:24.00] 这警告
[03:28.00] 
[03:32.00] 只是想让我知道
[03:36.00] 只是想让你知道
[03:40.00] 爱的警告
、`;


const lrc2 = `
[00:00.01]
[00:00.02]
[00:00.03]
[00:00.05]
[00:00.06]
[00:00.07]

[00:01.00] 青花瓷
[00:02.00] 词：方文山
[00:04.00] 曲：周杰伦
[00:06.00] 编曲：钟兴民

[00:20.00] 素胚勾勒出青花
[00:24.00] 笔锋浓转淡
[00:26.00] 瓶身描绘的牡丹
[00:28.00] 一如你初妆
[00:30.00] 冉冉檀香透过窗
[00:32.00] 心事我了然
[00:34.00] 宣纸上走笔至此
[00:37.00] 搁一半
[00:40.00] 釉色渲染仕女图
[00:42.00] 韵味被私藏
[00:44.00] 而你嫣然的一笑
[00:46.00] 如含苞待放
[00:48.00] 你的美一缕飘散
[00:50.00] 去到我去不了的地方

[00:57.00] 天青色等烟雨
[00:59.00] 而我在等你
[01:01.00] 炊烟袅袅升起
[01:03.00] 隔江千万里
[01:06.00] 在瓶底书汉隶仿
[01:08.00] 前朝的飘逸
[01:10.00] 就当我为遇见你
[01:12.00] 伏笔

[01:15.00] 天青色等烟雨
`;


var allup = document.querySelector(".allup-container");

var commentsContainer = document.querySelector(".comments-container");

var upper = document.querySelector(".upper-container");
// 获取主题背景
var body = document.getElementById('body');
// 获取音频播放器对象
var audio = document.getElementById('audioTag');

// 歌曲名
var musicTitle = document.getElementById('music-title');
var musicTitle2 = document.getElementById('song-title');
// 歌曲海报
var recordImg = document.getElementById('record-img');
var coverImg = document.getElementById('cover-img');
//歌词
// 歌曲作者
var author = document.getElementById('author-name');
var author2 = document.getElementById('song-artist');

// 进度条
var progress = document.getElementById('progress');
// 总进度条
var progressTotal = document.getElementById('progress-total');

// 已进行时长
var playedTime = document.getElementById('playedTime');
// 总时长
var audioTime = document.getElementById('audioTime');
// 播放模式按钮
var mode = document.getElementById('playMode');
// 上一首
var skipForward = document.getElementById('skipForward');
// 暂停按钮
var pause = document.getElementById('playPause');
// 下一首
var skipBackward = document.getElementById('skipBackward');
// 音量调节
var volume = document.getElementById('volume');
// 音量调节滑块
var volumeTogger = document.getElementById('volumn-togger');

// 列表
var list = document.getElementById('list');
// 倍速
var speed = document.getElementById('speed');
// MV
var MV = document.getElementById('MV');

// 左侧关闭面板
var closeList = document.getElementById('close-list');
// 音乐列表面板
var musicList = document.getElementById('music-list');
//实现点赞
var likeClicked = false;
document.getElementById("likesong").addEventListener("click", function() {
    var likeCountElement = this.querySelector(".like-count");
    var currentCount = parseInt(likeCountElement.textContent);
    
    if (likeClicked) {
        likeCountElement.textContent = currentCount - 1;
        
    } else {
        likeCountElement.textContent = currentCount + 1;
    }

    this.querySelector("i").classList.toggle("clicked");
    likeClicked = !likeClicked;
});

//实现评论滑动出现消失

var coverimgClicked = false;

document.getElementById("cover-img").addEventListener("click", function() {
   
    parent.postMessage("imageClicked", "*");
    if (coverimgClicked) {
        
        allup.style.maxHeight = "0"; // 隐藏时高度为0
    } else {
        allup.style.maxHeight = "88%"; // 设置最大高度
    }
    coverimgClicked = !coverimgClicked;
});

function imageClicked() {
    // 发送消息到父级页面
    parent.postMessage("imageClicked", "*");
}

//实现歌曲详情的滑动

var recordimgClicked = false;

document.getElementById("record-img").addEventListener("click", function() {
    

    if (recordimgClicked) {
        commentsContainer.style.maxHeight = "40%"; // 设置最大高度
        upper.style.height = "48%";
    } else {
        commentsContainer.style.maxHeight = "0"; // 隐藏时高度为0
        upper.style.height = "88%";
    }

    recordimgClicked = !recordimgClicked;
});


// 暂停/播放功能实现
pause.onclick = function (e) {
    if (audio.paused) {
        audio.play();
        rotateRecord();
        pause.classList.remove('icon-play');
        pause.classList.add('icon-pause');
    } else {
        audio.pause();
        rotateRecordStop();
        pause.classList.remove('icon-pause');
        pause.classList.add('icon-play');
    }
}

// 更新进度条
audio.addEventListener('timeupdate', updateProgress); // 监听音频播放时间并更新进度条
function updateProgress() {
    var value = audio.currentTime / audio.duration;
    progress.style.width = value * 100 + '%';
    playedTime.innerText = transTime(audio.currentTime);
   
}

//音频播放时间换算
function transTime(value) {
    var time = "";
    var h = parseInt(value / 3600);
    value %= 3600;
    var m = parseInt(value / 60);
    var s = parseInt(value % 60);
    if (h > 0) {
        time = formatTime(h + ":" + m + ":" + s);
    } else {
        time = formatTime(m + ":" + s);
    }

    return time;
}

// 格式化时间显示，补零对齐
function formatTime(value) {
    var time = "";
    var s = value.split(':');
    var i = 0;
    for (; i < s.length - 1; i++) {
        time += s[i].length == 1 ? ("0" + s[i]) : s[i];
        time += ":";
    }
    time += s[i].length == 1 ? ("0" + s[i]) : s[i];

    return time;
}

// 点击进度条跳到指定点播放
progressTotal.addEventListener('mousedown', function (event) {
    // 只有音乐开始播放后才可以调节，已经播放过但暂停了的也可以
    if (!audio.paused || audio.currentTime != 0) {
        var pgsWidth = parseFloat(window.getComputedStyle(progressTotal, null).width.replace('px', ''));
        var rate = event.offsetX / pgsWidth;
        audio.currentTime = audio.duration * rate;
        updateProgress(audio);
    }
});

// 点击列表展开音乐列表
list.addEventListener('click', function (event) {
    musicList.classList.remove("list-card-hide");
    musicList.classList.add("list-card-show");
    musicList.style.display = "flex";
    closeList.style.display = "flex";
    closeList.addEventListener('click', closeListBoard);
});

// 点击关闭面板关闭音乐列表
function closeListBoard() {
    musicList.classList.remove("list-card-show");
    musicList.classList.add("list-card-hide");
    closeList.style.display = "none";
}

// 存储当前播放的音乐序号
var musicId = 0;

// 后台音乐列表
let musicData = [['江南', '林俊杰'], ['我们背对背拥抱', '林俊杰'], ['青花瓷', '周杰伦']];
let lrc = [lrc0, lrc1,lrc2];
// 初始化音乐
function initMusic() {
    audio.src = "mp3/music" + musicId.toString() + ".mp3";
    audio.load();
    recordImg.classList.remove('rotate-play');
    coverImg.classList.remove('rotate-play');

    audio.ondurationchange = function () {
        musicTitle.innerText = musicData[musicId][0];
        musicTitle2.innerText = musicData[musicId][0];
        author.innerText = musicData[musicId][1];
        author2.innerText = musicData[musicId][1];
        recordImg.style.backgroundImage = "url('img/record"+musicId.toString()+".jpg')";
        coverImg.style.backgroundImage = "url('img/cover"+musicId.toString()+".jpg')";
      
        allup.style.backgroundImage = "url('img/bg"+musicId.toString()+".png')";
         // 更新歌词数据和歌词元素
        updateLrcAndElements(lrc[musicId]);
        
        audioTime.innerText = transTime(audio.duration);
        // 重置进度条
        audio.currentTime = 0;
        updateProgress();
        refreshRotate();
    }
}
initMusic();

// 初始化并播放
function initAndPlay() {
    initMusic();
    pause.classList.remove('icon-play');
    pause.classList.add('icon-pause');
    audio.play();
    rotateRecord();
}

// 播放模式设置
var modeId = 1;
mode.addEventListener('click', function (event) {
    modeId = modeId + 1;
    if (modeId > 3) {
        modeId = 1;
    }
    mode.style.backgroundImage = "url('img/mode" + modeId.toString() + ".png')";
});

audio.onended = function () {
    if (modeId == 2) {
        // 跳转至下一首歌
        musicId = (musicId + 1) % 4;
    }
    else if (modeId == 3) {
        // 随机生成下一首歌的序号
        var oldId = musicId;
        while (true) {
            musicId = Math.floor(Math.random() * 3) + 0;
            if (musicId != oldId) { break; }
        }
    }
    initAndPlay();
}

// 上一首
skipForward.addEventListener('click', function (event) {
    musicId = musicId - 1;
    if (musicId < 0) {
        musicId = 2;
    }
    initAndPlay();
});

// 下一首
skipBackward.addEventListener('click', function (event) {
    musicId = musicId + 1;
    if (musicId > 2) {
        musicId = 0;
    }
   
    // 初始化并播放新音乐
    initAndPlay();
  
});

// 倍速功能（这里直接暴力解决了）
speed.addEventListener('click', function (event) {
    var speedText = speed.innerText;
    if (speedText == "1.0X") {
        speed.innerText = "1.5X";
        audio.playbackRate = 1.5;
    }
    else if (speedText == "1.5X") {
        speed.innerText = "2.0X";
        audio.playbackRate = 2.0;
    }
    else if (speedText == "2.0X") {
        speed.innerText = "0.5X";
        audio.playbackRate = 0.5;
    }
    else if (speedText == "0.5X") {
        speed.innerText = "1.0X";
        audio.playbackRate = 1.0;
    }
});

// MV功能
MV.addEventListener('click', function (event) {

    window.open("mv_play.html");
});

// 暴力捆绑列表音乐
document.getElementById("music0").addEventListener('click', function (event) {
    musicId = 0;
    initAndPlay();
});
document.getElementById("music1").addEventListener('click', function (event) {
    musicId = 1;
    initAndPlay();
});
document.getElementById("music2").addEventListener('click', function (event) {
    musicId = 2;
    initAndPlay();
});


// 刷新唱片旋转角度
function refreshRotate() {
    recordImg.classList.add('rotate-play');
}

// 使唱片旋转
function rotateRecord() {
    recordImg.style.animationPlayState = "running"
}

// 停止唱片旋转
function rotateRecordStop() {
    recordImg.style.animationPlayState = "paused"
}

// 存储上一次的音量
var lastVolumn = 70

// 滑块调节音量
audio.addEventListener('timeupdate', updateVolumn);
function updateVolumn() {
    audio.volume = volumeTogger.value / 70;
}

// 点击音量调节设置静音
volume.addEventListener('click', setNoVolumn);
function setNoVolumn() {
    if (volumeTogger.value == 0) {
        if (lastVolumn == 0) {
            lastVolumn = 70;
        }
        volumeTogger.value = lastVolumn;
        volume.style.backgroundImage = "url('img/音量.png')";
    }
    else {
        lastVolumn = volumeTogger.value;
        volumeTogger.value = 0;
        volume.style.backgroundImage = "url('img/静音.png')";
    }
}




function parseLrc() {
    // 将歌词字符串分割成行数组

    const result = []; // 存储歌词对象的数组   
    // 遍历每一行歌词字符串
    for (let i = 0; i < lines.length; i++) {
      const str = lines[i];
      // 按照右括号分割歌词时间和歌词内容
      const parts = str.split("]");
      // 获取歌词时间字符串，并去掉左括号
      const timeStr = parts[0].substring(1);
      // 将时间字符串转换为数值
      const obj = {
        time: parseTime(timeStr), // 调用parseTime函数转换时间字符串
        words: parts[1] // 获取歌词内容
      };
      // 将歌词对象添加到结果数组中
      result.push(obj);
    }
  
    return result;
  }

  function parseTime(timeStr) {
    const parts = timeStr.split(":"); // 按照冒号分割时间字符串
    // 计算时间数值，将分钟转换为秒并加上秒数
    return +parts[0] * 60 + +parts[1];
  }
  

  // 获取需要的DOM元素
  const doms = {
    // audio: document.querySelector("audio"), // 音频元素
    ul: document.querySelector(".lrc-list"), // 歌词列表元素
    container: document.querySelector(".lyrics-container") // 歌词容器元素
  };
  
  /**
   * 计算出在当前播放器放到第几秒的情况下
   * lrcData数组中，应该高亮显示的歌词下标
   * 如果没有任何一句显示，则为-1
   */
  function findIndex() {
    const curTime = audio.currentTime;
   
    for (let i = 0; i < lrcData.length; i++) {
      if (curTime < lrcData[i].time) {
        return lrcData[i - 1].words ? i - 1 : i - 2;
      }
    }
    // 找遍了没有找到（说明播放到歌词的最后一句
    return lrcData.length - 1;
  }
  
  // 界面
  
  /**
   * 创建歌词元素li
   * 用文档片段一次性加元素节点，减少回流次数
   */
  function createElements() {
    const frag = document.createDocumentFragment(); // 文档片段
    for (let i = 0; i < lrcData.length; i++) {
      const li = document.createElement("li");
      li.textContent = lrcData[i].words;
      frag.appendChild(li);
    }
    doms.ul.appendChild(frag);
  }
//初始化歌词
var lines = lrc0.split("\n");
var lrcData = parseLrc();
createElements();
  
// 获取容器的高度
const containerHight = doms.container.clientHeight;

// 获取列表项的高度（假设所有列表项高度相同）
const liHight = doms.ul.children[0].clientHeight;

// 计算最大偏移量，即滚动范围
const maxOffset = doms.ul.clientHeight - containerHight;

// 用于跟踪前一个高亮元素的索引
let prevHighlightedIndex = -1;

// 设置偏移量以确保当前选定项位于可见区域中央
function setOffset() {
  // 找到当前选定项的索引
  const index = findIndex();
 
  // 计算应该滚动到的偏移量
  let offset = liHight * index + liHight / 2 - containerHight / 2;
  
  // 限制偏移量在合理范围内
  if (offset < 0) {
    offset = 0;
  }
  if (offset > maxOffset) {
    offset = maxOffset;
  }
  
  // 应用偏移量以滚动列表
  doms.ul.style.transform = `translateY(-${offset}px)`;
  
  // 去掉之前高亮的样式
  let li = doms.ul.querySelector(".active");
  if (li) {
    li.classList.remove("active");
  }
  // 高亮当前选定项
  li = doms.ul.children[index];
  if (li) {
    // 检查是否需要更新滚动条位置
    li.classList.add("active");
  }
  if(prevHighlightedIndex!=index&&index>4)
  {
    doms.container.scrollTop += 30*(index-6-prevHighlightedIndex);
    prevHighlightedIndex = index-6;
  
  }
  
}
  // 设置偏移量给ul
  // 解析歌词字符串



  // 事件
audio.addEventListener("timeupdate", setOffset);


function updateLrcAndElements(lrcText) {
    // 更新歌词文本
    lines = lrcText.split("\n");
    // 解析歌词数据
    lrcData = parseLrc();
    // 清除旧的歌词元素
    clearLrcElements();
    // 创建新的歌词元素
    createElements();
    // 重新设置事件监听器
    audio.removeEventListener("timeupdate", setOffset); // 移除之前的监听器
    audio.addEventListener("timeupdate", setOffset); // 添加新的监听器
}

// 清除旧的歌词元素
function clearLrcElements() {
    while (doms.ul.firstChild) {
        doms.ul.removeChild(doms.ul.firstChild);
    }
}

  


